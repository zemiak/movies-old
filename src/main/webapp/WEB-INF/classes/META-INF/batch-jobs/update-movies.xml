<?xml version="1.0" encoding="UTF-8"?>

<job id="update-movies" xmlns="http://xmlns.jcp.org/xml/ns/javaee" version="1.0">
    <properties>
        <property name="fileList" value="/tmp/movies-filelist"/>
    </properties>

    <flow id="newmovies" next="metadata">
        <step id="newmovies-prepare" next="newmovies-preparelog">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>

            <batchlet ref="PrepareFileList"></batchlet>
        </step>

        <step id="newmovies-preparelog" next="newmovies-run">
            <batchlet ref="PrepareLogFile"></batchlet>
        </step>

        <step id="newmovies-run" next="newmovies-cleanup">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>

            <chunk item-count="1">
                <reader ref="FilenameItemReader"></reader>
                <processor ref="NewmoviesProcessor"></processor>
                <writer ref="NewmoviesWriter"></writer>
            </chunk>
        </step>

        <step id="newmovies-cleanup" >
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="com.zemiak.movies.batch.service.RemoveFileList">
            </batchlet>
        </step>
    </flow>

    <flow id="metadata" next="descriptions">
        <step id="metadata-prepare" next="metadata-run">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="PrepareFileList"></batchlet>
        </step>

        <step id="metadata-run" next="metadata-cleanup">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>

            <chunk item-count="1">
                <reader ref="FilenameItemReader"></reader>
                <processor ref="MetadataProcessor"></processor>
                <writer ref="MetadataWriter"></writer>
            </chunk>
        </step>

        <step id="metadata-cleanup" >
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="com.zemiak.movies.batch.service.RemoveFileList">
            </batchlet>
        </step>
    </flow>
    
    <flow id="descriptions" next="thumbnails">
        <step id="descriptions-prepare" next="descriptions-run">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="PrepareFileList"></batchlet>
        </step>

        <step id="descriptions-run" next="descriptions-cleanup">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>

            <chunk item-count="1">
                <reader ref="FilenameItemReader"></reader>
                <processor ref="DescriptionsProcessor"></processor>
                <writer ref="DescriptionsWriter"></writer>
            </chunk>
        </step>

        <step id="descriptions-cleanup" >
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="com.zemiak.movies.batch.service.RemoveFileList">
            </batchlet>
        </step>
    </flow>

    <flow id="thumbnails" next="updateStorageCleanup">
        <step id="thumbnails-prepare" next="thumbnails-run">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="PrepareFileList"></batchlet>
        </step>

        <step id="thumbnails-run" next="thumbnails-cleanup">
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>

            <chunk item-count="1">
                <reader ref="FilenameItemReader"></reader>
                <processor ref="ThumbnailsProcessor"></processor>
                <writer ref="ThumbnailsWriter"></writer>
            </chunk>
        </step>

        <step id="thumbnails-cleanup" >
            <listeners>
                <listener ref="com.zemiak.movies.batch.service.Listener"/>
            </listeners>
            <batchlet ref="com.zemiak.movies.batch.service.RemoveFileList">
            </batchlet>
        </step>
    </flow>

    <flow id="updateStorageCleanup">
        <step id="refreshStorage" next="sendLog">
            <batchlet ref="BatchRefreshStorage"></batchlet>
        </step>

        <step id="sendLog" next="saveLog">
            <batchlet ref="SendLogFile"></batchlet>
        </step>

        <step id="saveLog" next="indicateChange">
            <batchlet ref="PersistLogFile"></batchlet>
        </step>

        <step id="indicateChange">
            <batchlet ref="MetadataChanged"></batchlet>
        </step>
    </flow>
</job>
